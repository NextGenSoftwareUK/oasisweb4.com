<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark">
  <title>Sign in · OASIS</title>
  <link rel="icon" type="image/png" href="../oasis-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="auth.css">
</head>
<body>
  <div class="auth-page">
    <div class="auth-card">
      <div class="auth-logo"><a href="/"><img src="../oasis-logo.png" alt="OASIS"></a></div>
      <h1 class="auth-title">Sign in</h1>
      <p class="auth-subtitle">Use your username or email and password.</p>
      <form id="form" class="auth-form">
        <label for="username">Username or email</label>
        <input type="text" id="username" name="username" required autocomplete="username" placeholder="you@example.com or username">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" required autocomplete="current-password" placeholder="Your password">
        <button type="submit" class="auth-btn" id="submitBtn">Sign in</button>
      </form>
      <div id="msg" class="auth-msg" role="alert"></div>
      <div class="auth-footer">
        <p>OASIS · Our World</p>
        <div class="auth-links">
          <a href="register">Create account</a>
          <a href="forgot-password">Forgot password?</a>
          <a href="/">Home</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function () {
      var apiBase = getApiBase();
      var form = document.getElementById('form');
      var submitBtn = document.getElementById('submitBtn');
      var msgEl = document.getElementById('msg');

      function getApiBase() {
        if (window.OASIS_API_BASE) return window.OASIS_API_BASE;
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
          return 'http://localhost:5003/api';
        return 'https://api.oasisweb4.com/api';
      }

      function showMsg(text, isError) {
        msgEl.textContent = text;
        msgEl.className = 'auth-msg ' + (isError ? 'error' : 'success');
        msgEl.style.display = 'block';
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var username = document.getElementById('username').value.trim();
        if (!username) {
          showMsg('Please enter your username or email.', true);
          return;
        }
        submitBtn.disabled = true;
        msgEl.style.display = 'none';

        var payload = { username: username, password: document.getElementById('password').value };

        fetch(apiBase + '/avatar/authenticate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function (res) {
            return res.json().then(function (data) {
              return { ok: res.ok, status: res.status, data: data };
            }).catch(function () {
              return { ok: res.ok, status: res.status, data: null };
            });
          })
          .then(function (out) {
            var data = out.data;
            var result = data && (data.result !== undefined ? data.result : data);
            if (!out.ok) {
              var errMsg = (result && result.message) || (data && data.message);
              if (out.status === 401) showMsg(errMsg || 'Invalid username or password.', true);
              else showMsg(errMsg || 'Sign in failed. Please try again.', true);
              return;
            }
            if (result && result.isError && result.message) {
              showMsg(result.message, true);
              return;
            }
            var avatar = result && result.result ? result.result : result;
            var token = avatar && (avatar.jwtToken || avatar.JwtToken);
            if (token) {
              try { localStorage.setItem('oasis_jwt', token); } catch (err) {}
              showMsg('Signed in successfully. Taking you home…', false);
              setTimeout(function () { window.location.href = '/'; }, 1200);
            } else {
              showMsg('Signed in. Redirecting…', false);
              setTimeout(function () { window.location.href = '/'; }, 800);
            }
          })
          .catch(function () {
            showMsg('Sign in failed. Check your connection and try again.', true);
          })
          .finally(function () { submitBtn.disabled = false; });
      });
    })();
  </script>
</body>
</html>
