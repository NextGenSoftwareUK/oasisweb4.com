<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark">
  <title>Set new password · OASIS</title>
  <link rel="icon" type="image/png" href="../oasis-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="auth.css">
</head>
<body>
  <div class="auth-page">
    <div class="auth-card">
      <div class="auth-logo"><a href="/"><img src="../oasis-logo.png" alt="OASIS"></a></div>
      <h1 class="auth-title">Set new password</h1>
      <p class="auth-subtitle">Enter your new password below. This link is valid for 24 hours.</p>
      <form id="form" class="auth-form">
        <label for="newPassword">New password</label>
        <div class="auth-password-wrap">
          <input type="password" id="newPassword" name="newPassword" required minlength="6" autocomplete="new-password" placeholder="At least 6 characters">
          <button type="button" class="auth-password-toggle" onclick="this.previousElementSibling.type=this.previousElementSibling.type==='password'?'text':'password';this.textContent=this.previousElementSibling.type==='password'?'Show':'Hide'">Show</button>
        </div>
        <label for="confirmPassword">Confirm new password</label>
        <div class="auth-password-wrap">
          <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6" autocomplete="new-password" placeholder="Repeat password">
          <button type="button" class="auth-password-toggle" onclick="this.previousElementSibling.type=this.previousElementSibling.type==='password'?'text':'password';this.textContent=this.previousElementSibling.type==='password'?'Show':'Hide'">Show</button>
        </div>
        <button type="submit" class="auth-btn" id="submitBtn">Reset password</button>
      </form>
      <div id="msg" class="auth-msg" role="alert"></div>
      <div class="auth-footer">
        <p>OASIS · Our World</p>
        <div class="auth-links">
          <a href="forgot-password">Request a new link</a>
          <a href="sign-in">Sign in</a>
          <a href="/">Home</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function () {
      var apiBase = getApiBase();
      var params = new URLSearchParams(window.location.search);
      var token = (params.get('token') || '').trim();
      var form = document.getElementById('form');
      var newPass = document.getElementById('newPassword');
      var confirmPass = document.getElementById('confirmPassword');
      var submitBtn = document.getElementById('submitBtn');
      var msgEl = document.getElementById('msg');

      function getApiBase() {
        if (window.OASIS_API_BASE) return window.OASIS_API_BASE;
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
          return 'http://localhost:5003/api';
        return 'https://api.oasisweb4.com/api';
      }

      function showMsg(text, isError) {
        msgEl.textContent = text;
        msgEl.className = 'auth-msg ' + (isError ? 'error' : 'success');
        msgEl.style.display = 'block';
      }

      if (!token) {
        msgEl.innerHTML = 'Missing reset token. Use the link from your email. <a href="forgot-password">Request a new link</a> or <a href="sign-in">Sign in</a>.';
        msgEl.className = 'auth-msg error';
        msgEl.style.display = 'block';
        form.style.display = 'none';
        return;
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var newP = newPass.value;
        var conf = confirmPass.value;
        if (newP !== conf) {
          showMsg('Passwords do not match.', true);
          return;
        }
        if (newP.length < 6) {
          showMsg('Password must be at least 6 characters.', true);
          return;
        }
        submitBtn.disabled = true;
        msgEl.style.display = 'none';

        fetch(apiBase + '/avatar/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: token,
            oldPassword: '',
            newPassword: newP,
            confirmNewPassword: conf
          })
        })
          .then(function (res) {
            return res.json().then(function (data) {
              return { ok: res.ok, status: res.status, data: data };
            }).catch(function () {
              return { ok: res.ok, status: res.status, data: null };
            });
          })
          .then(function (out) {
            var data = out.data;
            var result = data && (data.result !== undefined ? data.result : data);
            if (!out.ok && result && result.message) {
              showMsg(result.message, true);
              return;
            }
            if (result && result.isError && result.message) {
              var msg = result.message;
              var isExpired = (msg || '').toLowerCase().indexOf('expired') >= 0 || (msg || '').toLowerCase().indexOf('invalid') >= 0;
              if (isExpired) {
                msgEl.innerHTML = (msg || 'This link has expired.') + ' <a href="forgot-password">Request a new link</a> or <a href="sign-in">Sign in</a>.';
              } else {
                msgEl.innerHTML = msg + ' <a href="forgot-password">Request a new link</a> or <a href="sign-in">Sign in</a>.';
              }
              msgEl.className = 'auth-msg error';
              msgEl.style.display = 'block';
              return;
            }
            if (out.ok) {
              msgEl.innerHTML = 'Password updated. <a href="sign-in">Sign in</a> with your new password.';
              msgEl.className = 'auth-msg success';
              msgEl.style.display = 'block';
              form.style.display = 'none';
            } else {
              msgEl.innerHTML = ((result && result.message) || 'Reset failed.') + ' <a href="forgot-password">Request a new link</a> or <a href="sign-in">Sign in</a>.';
              msgEl.className = 'auth-msg error';
              msgEl.style.display = 'block';
            }
          })
          .catch(function () {
            msgEl.innerHTML = 'Something went wrong. Please check your connection. <a href="forgot-password">Request a new link</a> or <a href="sign-in">Sign in</a>.';
            msgEl.className = 'auth-msg error';
            msgEl.style.display = 'block';
          })
          .finally(function () { submitBtn.disabled = false; });
      });
    })();
  </script>
</body>
</html>
