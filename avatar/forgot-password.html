<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark">
  <title>Forgot password · OASIS</title>
  <link rel="icon" type="image/png" href="../oasis-logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="auth.css">
</head>
<body>
  <div class="auth-page">
    <div class="auth-card">
      <div class="auth-logo"><a href="/"><img src="../oasis-logo.png" alt="OASIS"></a></div>
      <h1 class="auth-title">Reset your password</h1>
      <p class="auth-subtitle">Enter the email for your OASIS account. We’ll send you a link to choose a new password.</p>
      <form id="form" class="auth-form">
        <label for="email">Email address</label>
        <input type="email" id="email" name="email" placeholder="you@example.com" required autocomplete="email">
        <button type="submit" class="auth-btn" id="submitBtn">Send reset link</button>
      </form>
      <div id="msg" class="auth-msg" role="alert"></div>
      <div class="auth-footer">
        <p>OASIS · Our World</p>
        <div class="auth-links">
          <a href="sign-in">Sign in</a>
          <a href="register">Create account</a>
          <a href="/">Home</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    (function () {
      var apiBase = getApiBase();
      var form = document.getElementById('form');
      var emailInput = document.getElementById('email');
      var submitBtn = document.getElementById('submitBtn');
      var msgEl = document.getElementById('msg');

      function getApiBase() {
        if (window.OASIS_API_BASE) return window.OASIS_API_BASE;
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
          return 'http://localhost:5003/api';
        return 'https://api.oasisweb4.com/api';
      }

      function showMsg(text, isError) {
        msgEl.textContent = text;
        msgEl.className = 'auth-msg ' + (isError ? 'error' : 'success');
        msgEl.style.display = 'block';
      }

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        var email = (emailInput.value || '').trim();
        if (!email) return;
        submitBtn.disabled = true;
        msgEl.style.display = 'none';

        fetch(apiBase + '/avatar/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: email })
        })
          .then(function (res) {
            return res.json().then(function (data) {
              return { ok: res.ok, status: res.status, data: data };
            }).catch(function () {
              return { ok: res.ok, status: res.status, data: null };
            });
          })
          .then(function (out) {
            var result = out.data && (out.data.result !== undefined ? out.data.result : out.data);
            var message = (result && (result.result || result.message)) ? String(result.result || result.message) : '';
            if (result && result.isError && result.message) {
              showMsg(result.message, true);
              return;
            }
            if (message && message.toLowerCase().indexOf('check your email') !== -1) {
              showMsg('Check your email for password reset instructions. The link is valid for 24 hours.', false);
              form.reset();
            } else if (!out.ok && result && result.message) {
              showMsg(result.message, true);
            } else if (!out.ok) {
              showMsg('Request failed. Please try again later.', true);
            } else {
              showMsg(message || 'If an account exists for that email, you will receive reset instructions.', false);
              form.reset();
            }
          })
          .catch(function () {
            showMsg('Something went wrong. Please check your connection and try again.', true);
          })
          .finally(function () { submitBtn.disabled = false; });
      });
    })();
  </script>
</body>
</html>
